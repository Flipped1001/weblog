---
title: redis是”单线程“
date: 2022-03-15
tags:
 - redis
categories:
 - redis
 - 单线程
---

### redis是单线程的吗？

**Redis 单线程指的是[接收客户端请求→解析请求→进行数据读写等操作→发送数据给客户端] 这个过程是由一个线程 (主线程)来完成的**

Redis 程并不是单线程的，Redis 在启动的时候，是会启动**后台线程 (BIO)** 

- Redis 在 2.6 版本，会启动 2 个后台线程，分别处理关闭文件、AOF 刷盘这两个任务;
- Redis 在 4.0 版本之后，新增了一个新的后台线程，用来异步释放 Redis 内存，也就是 lazyfree 线程

关闭文件、AOF 刷盘、释放内存这三个任务都有各自的任务队列:

1. BIO_CLOSE_FILE，关闭文件任务队列: 当队列有任务后，后台线程会调用 close(fd)，将文件关闭
2. BIO_AOF_FSYNC，AOF刷盘任务队列: 当 AOF 日志配置成 everysec 选项后，主线程会把 AOF 写日志操作封装成一个任务，也放到队列中。当发现队列有任务后，后台线程会调用 fsync(fd)，将 AOF 文件刷盘，
3. BIO LAZY FREE，lazy free 任务队列: 当队列有任务后，后台线程会 free(obi) 释放对象/free(dict)删除数据库所有对象/free(skiplist) 释放跳表对象

### Redis单线程还这么快

1. Redis是**基于内存**的，大部分操作都在内存中完成
2. Redis**单线程模型避免多线程之间的竞争**，也省去了多线程之间切换带来的时间和性能上的开销
3. Redis采用**I/O多路复用**处理大量的客户端Socket请求

Redis采用单线程的原因：CPU不是制约Redis性能表现的瓶颈，减少系统复杂度，同时不会存在在线程切换、加锁解锁、死锁的问题

后面采用多线程的原因：网络硬件性能的提升，Redis的性能瓶颈也会出现在网络I/O上，索引在6.0之后Redis采用多线程，提升了Redis的I/O性能，默认还是一个线程处理命令但是也可以自己设置