---
title: TCP的优化
date: 2023-11-27
tags:
 - 计算机基础
 - 计算机网络
 - TCP
categories:
 - 计算机网络
---

<!-- more -->

## 如何优化TCP？

#### TCP三次握手的性能提升？

客户端优化：

SYN_SENT优化，跟据服务器的繁忙程度修改SNY重传次数

服务端优化：

SYN_RCV状态的优化,同样是修改重发次数
调整半连接队列的大小

如何绕过三次握手：

TCP_FAST_OPEN功能，第一次建立握手时还是三次链接，之后建立连接就不需要握手了
需要双方同时打开才能有效

#### TCP四次挥手性能的提升？

主动方的优化：

> CLOSE函数和SHUTDOWN函数的区别：
>
> close函数是直接完全断开连接，双方都不能发送或者接受消息， **此时，调用了 close 函数的一方的连接叫做「孤儿连接」**
>
> shutdown函数是优雅的可以控制只关闭一个方向的连接
>
> - SHUT_RD(0)：**关闭连接的「读」这个方向**，如果接收缓冲区有已接收的数据，则将会被丢弃，并且后续再收到新的数据，会对数据进行 ACK，然后悄悄地丢弃。也就是说，对端还是会接收到 ACK，在这种情况下根本不知道数据已经被丢弃了。
> - SHUT_WR(1)：**关闭连接的「写」这个方向**，这就是常被称为「半关闭」的连接。如果发送缓冲区还有未发送的数据，将被立即发送出去，并发送一个 FIN 报文给对端。
> - SHUT_RDWR(2)：相当于 SHUT_RD 和 SHUT_WR 操作各一次，**关闭套接字的读和写两个方向**。

被动方的优化：

> 如果双方同时关闭连接会出现什么？
>
> **双方在等待 ACK 报文的过程中，都等来了 FIN 报文。这是一种新情况，所以连接会进入一种叫做 CLOSING 的新状态，它替代了 FIN_WAIT2 状态**

#### TCP传输数据的性能提升？

TCP 连接是由内核维护的，内核会为每个连接建立内存缓冲区：

- 如果连接的内存配置过小，就无法充分使用网络带宽，TCP 传输效率就会降低；
- 如果连接的内存配置过大，很容易把服务器资源耗尽，这样就会导致新连接无法建立；

滑动窗口是如何影像传输速度的？
TCP报文发出去之后不会从内存中立马删除，因为重传的时候还需要用到

这样看来，只要进程能及时地调用 read 函数读取数据，并且接收缓冲区配置得足够大，那么接收窗口就可以无限地放大，发送方也就无限地提升发送速度。 

这是不能可能的，因为网络的传输能力是有限的，当发送方依据发送窗口，发送超过网络处理能力的报文时，路由器会直接丢弃这些报文。因此，缓冲区的内存并不是越大越好。

如何确定最大传输速度？

![](2024-05-16-20-35-40.png)